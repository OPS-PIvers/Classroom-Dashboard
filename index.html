<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Patrick+Hand&family=Roboto+Mono:wght@500&display=swap');

        body { font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }
        
        .widget {
            position: absolute; display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.95); border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s, transform 0.1s; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(10px);
        }
        .widget.minimized { height: 40px !important; width: 200px !important; overflow: hidden; }
        .widget.minimized .widget-content, .widget.minimized .resize-handle { display: none; }
        
        .widget-header {
            height: 40px; cursor: grab; display: flex; align-items: center;
            justify-content: space-between; padding: 0 10px;
            background: #f8fafc; border-bottom: 1px solid #e2e8f0;
        }
        .widget-header:active { cursor: grabbing; background: #f1f5f9; }
        
        .widget-content { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        
        .flip-container { perspective: 1000px; width: 100%; height: 100%; position: relative; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .flip-active { transform: rotateY(180deg); }
        .front, .back {
            backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
        }
        .back { transform: rotateY(180deg); background: #f1f5f9; padding: 1rem; overflow-y: auto; }

        .resize-handle { width: 15px; height: 15px; position: absolute; bottom: 0; right: 0; cursor: se-resize; z-index: 10; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .traffic-light { width: 60px; height: 60px; border-radius: 50%; opacity: 0.3; transition: 0.3s; border: 4px solid rgba(0,0,0,0.1); cursor: pointer; }
        .traffic-light.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 20px currentColor; }
        
        .hand-font { font-family: 'Patrick Hand', cursive; }
        .mono-font { font-family: 'Roboto Mono', monospace; }
        .check-item input:checked + span { text-decoration: line-through; color: #94a3b8; }

        .perm-error {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 1rem;
        }
        #save-indicator {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background-color: #22c55e; color: white; padding: 10px 20px;
            border-radius: 8px; font-weight: bold; z-index: 100;
            opacity: 0; transition: opacity 0.5s;
        }
        .dashboard-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .dashboard-item:hover {
            background-color: #f1f5f9;
        }
        .dashboard-item.active {
            background-color: #e0e7ff;
            color: #4f46e5;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen overflow-hidden transition-colors duration-500" id="app-body">

    <div id="app-container" class="w-full h-full relative z-0"></div>

    <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 bg-white/90 backdrop-blur shadow-2xl rounded-2xl px-3 py-2 border border-white/50 flex gap-1.5 items-center transition-all hover:scale-105 overflow-x-auto max-w-[95vw]">
        <button id="btn-save" class="p-2.5 rounded-xl hover:bg-blue-100 text-blue-600" title="Save Dashboard"><i class="fa-solid fa-save fa-lg"></i></button>
        <div class="w-px h-6 bg-gray-300 mx-1"></div>
        <button id="btn-my-dashboards" class="dock-btn p-2.5 rounded-xl hover:bg-purple-100 text-purple-600" title="My Dashboards"><i class="fa-solid fa-folder-open fa-lg"></i></button>
        <div class="w-px h-6 bg-gray-300 mx-1"></div>
        <button data-widget="clock" class="dock-btn p-2.5 rounded-xl hover:bg-slate-100 text-slate-700" title="Clock"><i class="fa-regular fa-clock fa-lg"></i></button>
        <button data-widget="timer" class="dock-btn p-2.5 rounded-xl hover:bg-indigo-50 text-indigo-600" title="Timer"><i class="fa-solid fa-stopwatch fa-lg"></i></button>
        <button data-widget="traffic" class="dock-btn p-2.5 rounded-xl hover:bg-red-50 text-red-500" title="Traffic Light"><i class="fa-solid fa-traffic-light fa-lg"></i></button>
        <button data-widget="text" class="dock-btn p-2.5 rounded-xl hover:bg-amber-50 text-amber-600" title="Text Note"><i class="fa-solid fa-note-sticky fa-lg"></i></button>
        <button data-widget="checklist" class="dock-btn p-2.5 rounded-xl hover:bg-emerald-50 text-emerald-600" title="Checklist"><i class="fa-solid fa-list-check fa-lg"></i></button>
        <button data-widget="random" class="dock-btn p-2.5 rounded-xl hover:bg-orange-50 text-orange-500" title="Name Picker"><i class="fa-solid fa-shuffle fa-lg"></i></button>
        <button data-widget="dice" class="dock-btn p-2.5 rounded-xl hover:bg-green-50 text-green-600" title="Dice"><i class="fa-solid fa-dice fa-lg"></i></button>
        <button data-widget="sound" class="dock-btn p-2.5 rounded-xl hover:bg-pink-50 text-pink-500" title="Sound Level"><i class="fa-solid fa-microphone-lines fa-lg"></i></button>
        <button data-widget="drawing" class="dock-btn p-2.5 rounded-xl hover:bg-purple-50 text-purple-500" title="Drawing"><i class="fa-solid fa-paintbrush fa-lg"></i></button>
        <button data-widget="qr" class="dock-btn p-2.5 rounded-xl hover:bg-slate-50 text-slate-600" title="QR Code"><i class="fa-solid fa-qrcode fa-lg"></i></button>
        <button data-widget="embed" class="dock-btn p-2.5 rounded-xl hover:bg-blue-50 text-blue-500" title="Embed Website"><i class="fa-solid fa-display fa-lg"></i></button>
        <button data-widget="timetable" class="dock-btn p-2.5 rounded-xl hover:bg-cyan-50 text-cyan-600" title="Timetable"><i class="fa-solid fa-table fa-lg"></i></button>
        <button data-widget="poll" class="dock-btn p-2.5 rounded-xl hover:bg-yellow-50 text-yellow-600" title="Poll"><i class="fa-solid fa-square-poll-vertical fa-lg"></i></button>
        <button data-widget="webcam" class="dock-btn p-2.5 rounded-xl hover:bg-teal-50 text-teal-600" title="Webcam"><i class="fa-solid fa-video fa-lg"></i></button>
        
        <div class="w-px h-6 bg-gray-300 mx-1"></div>
        <button id="btn-bg-menu" class="dock-btn p-2.5 rounded-xl hover:bg-gray-100 text-gray-600" title="Backgrounds"><i class="fa-solid fa-image fa-lg"></i></button>
        <div class="w-px h-6 bg-gray-300 mx-1"></div>
        <button id="btn-record-menu" class="dock-btn p-2.5 rounded-xl hover:bg-red-50 text-red-600" title="Record"><i class="fa-solid fa-circle fa-lg"></i></button>
    </div>

    <div id="record-menu" class="fixed bottom-24 right-4 bg-white rounded-xl shadow-xl p-4 hidden z-50 w-48 flex flex-col gap-2">
        <button class="record-opt p-2 rounded-lg hover:bg-slate-100 text-slate-700 text-left font-medium" data-type="voice"><i class="fa-solid fa-microphone mr-2 text-indigo-500"></i> Voice Only</button>
        <button class="record-opt p-2 rounded-lg hover:bg-slate-100 text-slate-700 text-left font-medium" data-type="screen"><i class="fa-solid fa-desktop mr-2 text-blue-500"></i> Screen Only</button>
        <button class="record-opt p-2 rounded-lg hover:bg-slate-100 text-slate-700 text-left font-medium" data-type="both"><i class="fa-solid fa-video mr-2 text-red-500"></i> Voice & Screen</button>
    </div>

    <div id="bg-menu" class="fixed bottom-24 right-4 bg-white rounded-xl shadow-xl p-4 hidden z-50 w-64 grid grid-cols-2 gap-2">
        <button data-bg="bg-slate-900" class="bg-opt h-16 rounded-lg bg-slate-900 border-2 border-transparent hover:border-indigo-500"></button>
        <button data-bg="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500" class="bg-opt h-16 rounded-lg bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 border-2 border-transparent hover:border-white"></button>
        <button data-bg="bg-emerald-800" class="bg-opt h-16 rounded-lg bg-emerald-800 border-2 border-transparent hover:border-white"></button>
        <button data-bg="bg-sky-200" class="bg-opt h-16 rounded-lg bg-sky-200 border-2 border-transparent hover:border-indigo-500"></button>
        <button data-bg="bg-orange-100" class="bg-opt h-16 rounded-lg bg-orange-100 border-2 border-transparent hover:border-indigo-500"></button>
        <div data-bg="bg-grid" class="bg-opt h-16 rounded-lg bg-slate-50 border-2 border-transparent hover:border-indigo-500 flex items-center justify-center text-slate-400 cursor-pointer" style="background-image: radial-gradient(#94a3b8 1px, transparent 1px); background-size: 10px 10px;"><i class="fa-solid fa-border-all"></i></div>
    </div>
    
    <div id="dashboards-menu" class="fixed bottom-24 left-10 bg-white rounded-xl shadow-xl p-4 hidden z-50 w-72 flex flex-col gap-2 max-h-96 overflow-y-auto">
        <h3 class="font-bold text-slate-700 mb-2">My Dashboards</h3>
        <div id="dashboards-list" class="flex flex-col gap-1">
            <div class="text-sm text-slate-500 italic">Loading...</div>
        </div>
        <button id="btn-new-dashboard" class="mt-2 p-2 rounded-lg bg-indigo-50 text-indigo-600 text-sm font-bold hover:bg-indigo-100 text-center">+ New Dashboard</button>
    </div>

    <div id="save-indicator">Saved!</div>

    <!-- TEMPLATES -->
    <template id="tpl-window-frame">
        <div class="flip-container">
            <div class="flipper">
                <div class="front">
                    <div class="widget-header">
                        <div class="flex items-center gap-2 text-slate-600 font-semibold text-sm">
                            <i class="widget-icon"></i> <span class="widget-title-text"></span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 text-slate-500 btn-settings"><i class="fa-solid fa-gear text-xs"></i></button>
                            <button class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 text-slate-500 btn-min"><i class="fa-solid fa-minus text-xs"></i></button>
                            <button class="w-6 h-6 flex items-center justify-center rounded hover:bg-red-100 text-red-500 btn-close"><i class="fa-solid fa-xmark text-xs"></i></button>
                        </div>
                    </div>
                    <div class="widget-content bg-white"></div>
                    <div class="resize-handle"><i class="fa-solid fa-caret-down absolute bottom-0 right-0 text-slate-400 text-xs pointer-events-none p-0.5"></i></div>
                </div>
                <div class="back shadow-inner">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-slate-700">Settings</h3>
                        <button class="text-sm bg-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-200 btn-settings-done">Done</button>
                    </div>
                    <div class="settings-container"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-clock">
        <div class="flex flex-col items-center justify-center h-full p-4 bg-white text-slate-800">
            <div class="text-5xl font-bold mono-font tracking-wider" data-id="time">12:00</div>
            <div class="text-lg text-slate-500 mt-2 font-light" data-id="date">Monday, Jan 1</div>
        </div>
        <div class="settings-form">
            <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" class="inp-24h"> <span class="text-sm">24-Hour Format</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" class="inp-sec" checked> <span class="text-sm">Show Seconds</span>
            </div>
        </div>
    </template>

    <template id="tpl-timer">
        <div class="flex flex-col items-center justify-center h-full p-4">
            <div class="text-6xl font-mono font-bold text-slate-700 mb-4" data-id="display">05:00</div>
            <div class="flex gap-2">
                <button class="btn-start px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"><i class="fa-solid fa-play"></i></button>
                <button class="btn-pause px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"><i class="fa-solid fa-pause"></i></button>
                <button class="btn-reset px-4 py-2 bg-slate-500 text-white rounded hover:bg-slate-600"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Set Timer (Minutes)</label>
            <input type="number" class="inp-min w-full border rounded p-2 mb-2" value="5">
            <div class="flex items-center gap-2">
                <input type="checkbox" class="inp-sound" checked> <span class="text-sm">Play Sound on Finish</span>
            </div>
        </div>
    </template>

    <template id="tpl-traffic">
        <div class="flex flex-col items-center justify-center h-full gap-4 p-4 bg-slate-800">
            <div class="traffic-light bg-red-500 text-red-500" data-color="red"></div>
            <div class="traffic-light bg-yellow-400 text-yellow-400" data-color="yellow"></div>
            <div class="traffic-light bg-green-500 text-green-500" data-color="green"></div>
        </div>
        <div class="settings-form"><p class="text-sm text-slate-500">No configuration available.</p></div>
    </template>

    <template id="tpl-text">
        <div class="w-full h-full p-4 outline-none text-lg hand-font" contenteditable="true" style="white-space: pre-wrap;">Click to type instructions...</div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Background Color</label>
            <div class="flex gap-2 mb-4">
                <div class="w-6 h-6 rounded-full bg-white border cursor-pointer bg-picker" data-color="#ffffff"></div>
                <div class="w-6 h-6 rounded-full bg-yellow-100 border cursor-pointer bg-picker" data-color="#fef9c3"></div>
                <div class="w-6 h-6 rounded-full bg-green-100 border cursor-pointer bg-picker" data-color="#dcfce7"></div>
                <div class="w-6 h-6 rounded-full bg-blue-100 border cursor-pointer bg-picker" data-color="#dbeafe"></div>
                <div class="w-6 h-6 rounded-full bg-pink-100 border cursor-pointer bg-picker" data-color="#fce7f3"></div>
            </div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Font Size</label>
            <input type="range" class="inp-size w-full" min="12" max="48" value="18">
        </div>
    </template>

    <template id="tpl-checklist">
        <div class="w-full h-full p-4 overflow-auto check-list-container">
            <div class="text-slate-400 text-sm italic">Add items in settings...</div>
        </div>
        <div class="settings-form h-full flex flex-col">
            <label class="block text-sm font-medium text-slate-700 mb-1">Checklist Items (One per line)</label>
            <textarea class="inp-list flex-1 w-full border rounded p-2 text-sm resize-none mb-2" placeholder="Read Chapter 1&#10;Complete Worksheet"></textarea>
            <button class="btn-update bg-indigo-600 text-white py-1 px-3 rounded text-sm self-end">Update List</button>
        </div>
    </template>

    <template id="tpl-timetable">
        <div class="w-full h-full p-4 overflow-auto">
            <table class="w-full text-sm">
                <tbody class="timetable-body"></tbody>
            </table>
            <div class="empty-msg text-slate-400 text-sm italic">Configure in settings...</div>
        </div>
        <div class="settings-form h-full flex flex-col">
            <label class="block text-sm font-medium text-slate-700 mb-1">Schedule (Time | Activity)</label>
            <textarea class="inp-data flex-1 w-full border rounded p-2 text-sm font-mono resize-none mb-2" placeholder="09:00 | Math&#10;10:00 | Recess&#10;10:30 | Science"></textarea>
            <button class="btn-apply bg-indigo-600 text-white py-1 px-3 rounded text-sm self-end">Build Table</button>
        </div>
    </template>

    <template id="tpl-random">
        <div class="flex flex-col items-center justify-center h-full p-4">
            <div class="result-container flex-1 w-full flex items-center justify-center overflow-hidden mb-4">
                <div class="result text-3xl font-bold text-indigo-600 text-center hand-font break-words w-full">Ready?</div>
            </div>
            <button class="btn-pick px-6 py-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 font-bold transition-transform active:scale-95 z-10">Pick Student</button>
        </div>
        <div class="settings-form h-full flex flex-col">
            <label class="block text-sm font-medium text-slate-700 mb-1">Mode</label>
            <select class="inp-mode w-full border rounded p-2 mb-2 bg-white text-sm">
                <option value="single">Pick One</option>
                <option value="list">Randomize List</option>
                <option value="groups">Group Generator</option>
            </select>
            <div class="div-group-size hidden">
                <label class="block text-sm font-medium text-slate-700 mb-1">Group Size</label>
                <input type="number" class="inp-group-size w-full border rounded p-2 mb-2" value="3" min="2">
            </div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Student List (One per line)</label>
            <textarea class="inp-list flex-1 w-full border rounded p-2 text-sm font-mono resize-none" placeholder="Alice&#10;Bob&#10;Charlie"></textarea>
        </div>
    </template>

    <template id="tpl-dice">
        <div class="flex flex-col items-center justify-center h-full p-4 bg-green-50">
            <div class="dice-container flex gap-4 mb-6"></div>
            <button class="btn-roll px-6 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 font-bold"><i class="fa-solid fa-dice"></i> Roll</button>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Number of Dice</label>
            <select class="inp-count w-full border rounded p-2">
                <option value="1">1 Die</option>
                <option value="2">2 Dice</option>
                <option value="3">3 Dice</option>
            </select>
        </div>
    </template>

    <template id="tpl-qr">
        <div class="flex flex-col items-center justify-center h-full p-4">
            <img class="qr-img w-48 h-48 object-contain border-4 border-white shadow-lg rounded mb-2" src="" alt="QR Code">
            <div class="text-xs text-slate-400 truncate max-w-full px-4" data-id="url-display">Enter URL in Settings</div>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Target URL</label>
            <input type="text" class="inp-url w-full border rounded p-2" placeholder="https://google.com" value="https://google.com">
        </div>
    </template>

    <template id="tpl-sound">
        <div class="flex flex-col items-end justify-end h-full p-4 bg-slate-900 relative overflow-hidden">
            <div class="mic-bar w-full bg-gradient-to-t from-green-500 via-yellow-400 to-red-500 absolute bottom-0 left-0 opacity-80 transition-all duration-75" style="height: 0%;"></div>
            <div class="relative z-10 text-white font-bold bg-black/50 px-2 rounded"><i class="fa-solid fa-microphone"></i> Sensitivity</div>
            <div class="mic-overlay absolute inset-0 z-20 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm">
                <button class="btn-mic-start px-4 py-2 bg-pink-500 text-white rounded-full font-bold hover:bg-pink-600 shadow-lg">
                    <i class="fa-solid fa-microphone"></i> Enable Mic
                </button>
            </div>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Microphone Sensitivity</label>
            <input type="range" class="inp-sens w-full" min="1" max="10" value="5">
            <p class="text-xs text-slate-500 mt-2">Note: Requires browser microphone permission.</p>
        </div>
    </template>

    <template id="tpl-drawing">
        <div class="w-full h-full bg-white relative cursor-crosshair group">
            <canvas class="draw-canvas absolute inset-0 w-full h-full"></canvas>
            <div class="absolute bottom-2 left-2 flex gap-1 bg-white/90 p-1 rounded border shadow opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="w-6 h-6 rounded-full bg-black btn-color" data-color="black"></button>
                <button class="w-6 h-6 rounded-full bg-red-500 btn-color" data-color="red"></button>
                <button class="w-6 h-6 rounded-full bg-blue-500 btn-color" data-color="blue"></button>
                <button class="w-6 h-6 flex items-center justify-center text-slate-600 hover:bg-slate-200 rounded btn-clear"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>
        <div class="settings-form">
            <p class="text-sm text-slate-500">Canvas clears on resize. Use the toolbar on canvas to change colors.</p>
        </div>
    </template>

    <template id="tpl-embed">
        <div class="w-full h-full bg-black relative">
            <iframe class="embed-frame w-full h-full border-0" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            <div class="overlay absolute inset-0 flex items-center justify-center bg-slate-100 text-slate-500">
                <span>Set URL in Settings</span>
            </div>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Embed URL</label>
            <div class="flex gap-2">
                <input type="text" class="inp-embed w-full border rounded p-2" placeholder="https://..." value="">
                <button class="btn-load bg-blue-500 text-white px-3 rounded hover:bg-blue-600">Load</button>
            </div>
            <p class="text-xs text-slate-500 mt-1">Supports YouTube Embeds, Slides, etc.</p>
        </div>
    </template>

    <template id="tpl-poll">
        <div class="flex flex-col h-full p-4">
            <div class="flex-1 flex gap-2">
                <div class="flex-1 bg-indigo-100 rounded-lg flex flex-col items-center justify-end relative overflow-hidden cursor-pointer hover:bg-indigo-200 transition-colors btn-vote" data-idx="0">
                    <div class="bar bg-indigo-500 w-full transition-all duration-500" style="height: 0%"></div>
                    <span class="absolute bottom-2 font-bold text-indigo-800 count">0</span>
                    <span class="absolute top-2 text-xs font-bold text-indigo-400 opt-label">A</span>
                </div>
                <div class="flex-1 bg-pink-100 rounded-lg flex flex-col items-center justify-end relative overflow-hidden cursor-pointer hover:bg-pink-200 transition-colors btn-vote" data-idx="1">
                    <div class="bar bg-pink-500 w-full transition-all duration-500" style="height: 0%"></div>
                    <span class="absolute bottom-2 font-bold text-pink-800 count">0</span>
                    <span class="absolute top-2 text-xs font-bold text-pink-400 opt-label">B</span>
                </div>
            </div>
            <button class="mt-2 text-xs text-slate-400 hover:text-slate-600 text-center btn-reset">Reset Votes</button>
        </div>
        <div class="settings-form">
            <label class="block text-sm font-medium text-slate-700 mb-1">Option A Label</label>
            <input type="text" class="inp-opt-a w-full border rounded p-2 mb-2" value="Yes">
            <label class="block text-sm font-medium text-slate-700 mb-1">Option B Label</label>
            <input type="text" class="inp-opt-b w-full border rounded p-2" value="No">
        </div>
    </template>

    <template id="tpl-webcam">
        <div class="w-full h-full bg-black relative overflow-hidden flex items-center justify-center">
            <video class="cam-feed w-full h-full object-cover transform scale-x-[-1]" autoplay playsinline muted></video>
            <button class="btn-cam-start absolute z-10 bg-white/20 hover:bg-white/40 text-white px-4 py-2 rounded-full backdrop-blur">Start Camera</button>
        </div>
        <div class="settings-form">
            <p class="text-sm text-slate-500">Camera runs locally. No data is sent to any server.</p>
        </div>
    </template>

    <script>
        // Global State
        let widgets = [];
        let nextId = 1;
        let dragItem = null;
        let resizeItem = null;
        let initialMouseX, initialMouseY;
        let initialX, initialY, initialW, initialH;
        const GRID = 40;
        let polls = {};
        let currentDashboardName = null;
        let dashboards = {};

        // Main Initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Bind Dock Buttons
            document.querySelectorAll('.dock-btn[data-widget]').forEach(btn => {
                btn.addEventListener('click', () => spawnWidget(btn.dataset.widget));
            });

            // Bind Background Menu
            const bgMenuBtn = document.getElementById('btn-bg-menu');
            const bgMenu = document.getElementById('bg-menu');
            bgMenuBtn.addEventListener('click', () => {
                 bgMenu.classList.toggle('hidden');
                 document.getElementById('dashboards-menu').classList.add('hidden');
                 document.getElementById('record-menu').classList.add('hidden');
            });
            
            document.querySelectorAll('.bg-opt').forEach(btn => {
                btn.addEventListener('click', () => setBg(btn.dataset.bg));
            });

            // Bind Record Menu
            const recordMenuBtn = document.getElementById('btn-record-menu');
            const recordMenu = document.getElementById('record-menu');
            recordMenuBtn.addEventListener('click', () => {
                recordMenu.classList.toggle('hidden');
                document.getElementById('bg-menu').classList.add('hidden');
                document.getElementById('dashboards-menu').classList.add('hidden');
            });

            document.querySelectorAll('.record-opt').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    recordMenu.classList.add('hidden');
                    startRecording(type);
                });
            });

            // Bind Dashboards Menu
            const dashboardMenuBtn = document.getElementById('btn-my-dashboards');
            const dashboardMenu = document.getElementById('dashboards-menu');
            dashboardMenuBtn.addEventListener('click', () => {
                dashboardMenu.classList.toggle('hidden');
                document.getElementById('bg-menu').classList.add('hidden');
                document.getElementById('record-menu').classList.add('hidden');
                renderDashboardList();
            });

            document.getElementById('btn-new-dashboard').addEventListener('click', () => {
                // Clear current dashboard
                widgets.forEach(w => w.el.remove());
                widgets = [];
                polls = {};
                currentDashboardName = null;
                setBg("bg-slate-900");
                dashboardMenu.classList.add('hidden');
                alert("New dashboard created. Don't forget to save!");
            });


            // Global Events
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            // Save/Load
            document.getElementById('btn-save').addEventListener('click', handleSaveClick);
            loadInitialData();
        });

        function spawnWidget(type, state = null) {
            const id = state ? state.id : nextId++;
            if (!state) { // If it is a new widget, increment nextId
               if(id >= nextId) nextId = id + 1;
            }
            
            const config = getWidgetConfig(type);
            
            const frameTpl = document.getElementById('tpl-window-frame');
            if(!frameTpl) return console.error("Missing Frame Template");
            
            const skeleton = frameTpl.content.cloneNode(true);
            const el = document.createElement('div');
            el.className = 'widget';
            el.id = 'widget-' + id;
            
            if (state) {
                el.style.left = state.x + 'px';
                el.style.top = state.y + 'px';
                el.style.width = state.w + 'px';
                el.style.height = state.h + 'px';
                el.style.zIndex = state.z;
                if(state.minimized) el.classList.add('minimized');
            } else {
                 el.style.width = config.w + 'px';
                 el.style.height = config.h + 'px';
                 el.style.left = (window.innerWidth / 2 - config.w / 2) + 'px';
                 el.style.top = (window.innerHeight / 2 - config.h / 2) + 'px';
                 el.style.zIndex = getMaxZ() + 1;
            }

            skeleton.querySelector('.widget-title-text').textContent = config.title;
            skeleton.querySelector('.widget-icon').className = config.icon;
            
            const header = skeleton.querySelector('.widget-header');
            header.addEventListener('mousedown', (e) => startDrag(e, id));
            
            skeleton.querySelector('.btn-settings').addEventListener('click', () => toggleSettings(id));
            skeleton.querySelector('.btn-settings-done').addEventListener('click', () => toggleSettings(id));
            skeleton.querySelector('.btn-min').addEventListener('click', () => toggleMinimize(id));
            skeleton.querySelector('.btn-close').addEventListener('click', () => closeWidget(id));
            skeleton.querySelector('.resize-handle').addEventListener('mousedown', (e) => startResize(e, id));
            
            const flipper = skeleton.querySelector('.flipper');
            flipper.id = 'flipper-' + id;
            if(state && state.settings) flipper.classList.add('flip-active');

            const contentArea = skeleton.querySelector('.widget-content');
            contentArea.id = 'content-' + id;
            const settingsArea = skeleton.querySelector('.settings-container');
            settingsArea.id = 'settings-' + id;

            el.appendChild(skeleton);
            document.getElementById('app-container').appendChild(el);

            const typeTpl = document.getElementById('tpl-' + type);
            if(typeTpl) {
                const clone = typeTpl.content.cloneNode(true);
                const settingsForm = clone.querySelector('.settings-form');
                if(settingsForm) settingsArea.appendChild(settingsForm);
                contentArea.appendChild(clone);
            }

            const widget = { id, type, el };
            widgets.push(widget);
            initWidgetLogic(widget, state ? state.data : null);

            return widget;
        }

        function getWidgetConfig(type) {
            const defaults = {
                clock: { w: 280, h: 160, title: 'Clock', icon: 'fa-regular fa-clock' },
                timer: { w: 300, h: 220, title: 'Timer', icon: 'fa-solid fa-stopwatch' },
                traffic: { w: 140, h: 320, title: 'Signal', icon: 'fa-solid fa-traffic-light' },
                text: { w: 250, h: 200, title: 'Note', icon: 'fa-solid fa-note-sticky' },
                checklist: { w: 300, h: 400, title: 'Checklist', icon: 'fa-solid fa-list-check' },
                timetable: { w: 400, h: 300, title: 'Timetable', icon: 'fa-solid fa-table' },
                random: { w: 300, h: 250, title: 'Name Picker', icon: 'fa-solid fa-shuffle' },
                dice: { w: 250, h: 200, title: 'Dice', icon: 'fa-solid fa-dice' },
                qr: { w: 250, h: 320, title: 'QR Code', icon: 'fa-solid fa-qrcode' },
                sound: { w: 200, h: 300, title: 'Noise Level', icon: 'fa-solid fa-microphone-lines' },
                drawing: { w: 400, h: 300, title: 'Sketch', icon: 'fa-solid fa-paintbrush' },
                embed: { w: 480, h: 320, title: 'Embed', icon: 'fa-solid fa-display' },
                poll: { w: 300, h: 250, title: 'Quick Poll', icon: 'fa-solid fa-square-poll-vertical' },
                webcam: { w: 320, h: 240, title: 'Camera', icon: 'fa-solid fa-video' }
            };
            return defaults[type] || { w: 300, h: 200, title: 'Widget', icon: 'fa-solid fa-cube' };
        }

        function initWidgetLogic(w, state) {
            const root = w.el;

            if (w.type === 'clock') {
                const timeEl = root.querySelector('[data-id="time"]');
                const dateEl = root.querySelector('[data-id="date"]');
                const inp24h = root.querySelector('.inp-24h');
                const inpSec = root.querySelector('.inp-sec');
                
                if(state){
                    inp24h.checked = state.is24h;
                    inpSec.checked = state.showSeconds;
                }

                const update = () => {
                    if(!root.isConnected) return;
                    const now = new Date();
                    const opts = { hour: 'numeric', minute: '2-digit', hour12: !inp24h.checked };
                    if(inpSec.checked) opts.second = '2-digit';
                    timeEl.textContent = now.toLocaleTimeString([], opts);
                    dateEl.textContent = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
                    requestAnimationFrame(update);
                };
                update();

                w.getState = () => ({
                    is24h: inp24h.checked,
                    showSeconds: inpSec.checked
                });
            }

            if (w.type === 'timer') {
                let interval;
                let time = state ? state.initialTime : 300;
                const display = root.querySelector('[data-id="display"]');
                const inpMin = root.querySelector('.inp-min');
                const inpSound = root.querySelector('.inp-sound');

                if(state){
                    inpMin.value = time / 60;
                    inpSound.checked = state.playSound;
                }

                const updateDisplay = () => {
                    const m = Math.floor(time / 60).toString().padStart(2, '0');
                    const s = (time % 60).toString().padStart(2, '0');
                    display.textContent = m + ':' + s;
                };

                root.querySelector('.btn-start').addEventListener('click', () => {
                    clearInterval(interval);
                    interval = setInterval(() => {
                        if (time > 0) {
                            time--;
                            updateDisplay();
                        } else {
                            clearInterval(interval);
                            if(inpSound.checked) playAlarm();
                            display.classList.add('text-red-500', 'animate-pulse');
                        }
                    }, 1000);
                });
                root.querySelector('.btn-pause').addEventListener('click', () => clearInterval(interval));
                root.querySelector('.btn-reset').addEventListener('click', () => {
                    clearInterval(interval);
                    time = parseInt(inpMin.value) * 60;
                    updateDisplay();
                    display.classList.remove('text-red-500', 'animate-pulse');
                });
                inpMin.addEventListener('change', () => {
                   time = parseInt(inpMin.value) * 60;
                   updateDisplay();
                });
                updateDisplay();

                 w.getState = () => ({
                    initialTime: parseInt(inpMin.value) * 60,
                    playSound: inpSound.checked
                });
            }

            if (w.type === 'traffic') {
                const lights = root.querySelectorAll('.traffic-light');
                if(state) {
                    lights.forEach(l => l.classList.remove('active'));
                    if(state.active) {
                       const activeLight = root.querySelector(`.traffic-light[data-color="${state.active}"]`);
                       if(activeLight) activeLight.classList.add('active');
                    }
                }
                lights.forEach(light => {
                    light.addEventListener('click', () => {
                        lights.forEach(l => l.classList.remove('active'));
                        light.classList.add('active');
                    });
                });
                
                w.getState = () => {
                    const activeLight = root.querySelector('.traffic-light.active');
                    return { active: activeLight ? activeLight.dataset.color : null };
                };
            }

            if (w.type === 'text') {
                const area = root.querySelector('.widget-content div');
                const slider = root.querySelector('.inp-size');
                const contentArea = root.querySelector('.widget-content');

                if(state){
                    area.innerHTML = state.content;
                    area.style.fontSize = state.fontSize + 'px';
                    slider.value = state.fontSize;
                    contentArea.style.backgroundColor = state.bgColor;
                }

                slider.addEventListener('input', () => {
                    area.style.fontSize = slider.value + 'px';
                });
                
                root.querySelectorAll('.bg-picker').forEach(btn => {
                    btn.addEventListener('click', () => {
                         contentArea.style.backgroundColor = btn.dataset.color;
                    });
                });

                w.getState = () => ({
                    content: area.innerHTML,
                    fontSize: slider.value,
                    bgColor: contentArea.style.backgroundColor
                });
            }

            if (w.type === 'checklist') {
                const container = root.querySelector('.check-list-container');
                const textarea = root.querySelector('.inp-list');
                const btn = root.querySelector('.btn-update');

                const renderList = (items) => {
                    container.innerHTML = '';
                    if (!items || items.length === 0) {
                         container.innerHTML = '<div class="text-slate-400 text-sm italic">Add items in settings...</div>';
                         return;
                    }
                    items.forEach((item, i) => {
                        const div = document.createElement('div');
                        div.className = 'check-item flex items-start gap-2 mb-2 p-1 hover:bg-slate-50 rounded';
                        div.innerHTML = `<input type="checkbox" class="mt-1 accent-indigo-600" id="chk-${w.id}-${i}" ${item.checked ? 'checked' : ''}>` +
                                        `<span class="flex-1 text-slate-700 break-words">${item.text}</span>`;
                        container.appendChild(div);
                    });
                }
                
                if(state){
                    textarea.value = state.items.map(i => i.text).join('\n');
                    renderList(state.items);
                }

                btn.addEventListener('click', () => {
                    const items = textarea.value.split('\n').filter(x => x.trim()).map(text => ({text, checked: false}));
                    renderList(items);
                    toggleSettings(w.id);
                });

                 w.getState = () => {
                    const items = [];
                     root.querySelectorAll('.check-item').forEach(itemEl => {
                        items.push({
                            text: itemEl.querySelector('span').textContent,
                            checked: itemEl.querySelector('input').checked
                        });
                    });
                    return { items };
                };
            }

            if (w.type === 'random') {
                const btn = root.querySelector('.btn-pick');
                const resultContainer = root.querySelector('.result-container');
                const result = root.querySelector('.result');
                const listInput = root.querySelector('.inp-list');
                const modeSelect = root.querySelector('.inp-mode');
                const groupSizeInput = root.querySelector('.inp-group-size');
                const groupSizeDiv = root.querySelector('.div-group-size');

                if(state){
                    listInput.value = state.list;
                    modeSelect.value = state.mode;
                    groupSizeInput.value = state.groupSize;
                }

                modeSelect.addEventListener('change', () => {
                    const mode = modeSelect.value;
                    if (mode === 'groups') {
                        groupSizeDiv.style.display = 'block';
                        btn.textContent = 'Make Groups';
                    } else if (mode === 'list') {
                        groupSizeDiv.style.display = 'none';
                        btn.textContent = 'Randomize Order';
                    } else {
                        groupSizeDiv.style.display = 'none';
                        btn.textContent = 'Pick Student';
                    }
                });
                modeSelect.dispatchEvent(new Event('change'));
                
                btn.addEventListener('click', () => {
                    let names = listInput.value.split('\n').filter(n => n.trim() !== '');
                    if (names.length === 0) names = ['No Names'];
                    const mode = modeSelect.value;
                    
                    resultContainer.className = 'result-container flex-1 w-full overflow-auto mb-4 px-2';
                    result.className = 'hand-font text-slate-700';
                    result.innerHTML = '';

                    for (let i = names.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        let temp = names[i];
                        names[i] = names[j];
                        names[j] = temp;
                    }

                    if (mode === 'single') {
                        resultContainer.className = 'result-container flex-1 w-full flex items-center justify-center overflow-hidden mb-4';
                        result.className = 'text-3xl font-bold text-indigo-600 text-center hand-font break-words w-full';
                        
                        let count = 0;
                        btn.disabled = true;
                        const anim = setInterval(() => {
                            result.textContent = names[Math.floor(Math.random() * names.length)];
                            count++;
                            if (count > 15) {
                                clearInterval(anim);
                                btn.disabled = false;
                                result.style.transform = 'scale(1.2)';
                                setTimeout(() => result.style.transform = 'scale(1)', 200);
                            }
                        }, 100);
                    } 
                    else if (mode === 'list') {
                        result.innerHTML = names.map((n,i) => `<div class="py-1 border-b border-slate-100 last:border-0">${i+1}. ${n}</div>`).join('');
                    } 
                    else if (mode === 'groups') {
                        const size = parseInt(groupSizeInput.value) || 3;
                        const groups = [];
                        for (let i = 0; i < names.length; i += size) {
                            groups.push(names.slice(i, i + size));
                        }
                        
                        result.className = 'hand-font text-slate-700 grid grid-cols-2 gap-2';
                        result.innerHTML = groups.map((g, i) => {
                            return `<div class="bg-indigo-50 rounded p-2 text-sm">
                                    <div class="font-bold text-indigo-600 mb-1">Group ${i+1}</div>
                                    ${g.map(n => `<div>${n}</div>`).join('')}
                                </div>`;
                        }).join('');
                    }
                });

                 w.getState = () => ({
                    list: listInput.value,
                    mode: modeSelect.value,
                    groupSize: groupSizeInput.value
                });
            }

            if (w.type === 'dice') {
                const btn = root.querySelector('.btn-roll');
                const container = root.querySelector('.dice-container');
                const select = root.querySelector('.inp-count');

                if(state) select.value = state.count;

                const renderDie = (val) => `<i class="fa-solid fa-dice-${['one', 'two', 'three', 'four', 'five', 'six'][val-1]} text-6xl text-indigo-600 animate-bounce"></i>`;

                btn.addEventListener('click', () => {
                    container.innerHTML = '';
                    const count = parseInt(select.value);
                    for(let i=0; i<count; i++) {
                        const val = Math.ceil(Math.random() * 6);
                        const d = document.createElement('div');
                        d.innerHTML = renderDie(val);
                        container.appendChild(d);
                    }
                });
                if(!state) btn.click(); 

                w.getState = () => ({ count: select.value });
            }

            if (w.type === 'qr') {
                const inp = root.querySelector('.inp-url');
                const img = root.querySelector('.qr-img');
                const txt = root.querySelector('[data-id="url-display"]');
                
                const update = () => {
                    const url = inp.value || 'https://google.com';
                    img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
                    txt.textContent = url;
                };

                if(state) inp.value = state.url;
                
                inp.addEventListener('input', update);
                update();

                w.getState = () => ({ url: inp.value });
            }

            if (w.type === 'embed') {
                const inp = root.querySelector('.inp-embed');
                const btn = root.querySelector('.btn-load');
                const frame = root.querySelector('.embed-frame');
                const overlay = root.querySelector('.overlay');

                const loadUrl = () => {
                    if(inp.value) {
                        frame.src = inp.value;
                        overlay.style.display = 'none';
                    } else {
                        overlay.style.display = 'flex';
                    }
                };

                if(state) {
                    inp.value = state.url;
                    loadUrl();
                }

                btn.addEventListener('click', loadUrl);

                w.getState = () => ({ url: inp.value });
            }

            if (w.type === 'drawing') {
                // Drawing state is not saved as it's complex (canvas data).
                // It will be a blank canvas on load.
                const canvas = root.querySelector('canvas');
                const ctx = canvas.getContext('2d');
                let drawing = false;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';

                const resizeCanvas = () => {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                     ctx.lineWidth = 3; // re-apply settings after resize
                     ctx.lineCap = 'round';
                };
                new ResizeObserver(resizeCanvas).observe(canvas.parentElement);


                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
                };
                canvas.addEventListener('mousedown', (e) => {
                    drawing = true;
                    ctx.beginPath();
                    const p = getPos(e);
                    ctx.moveTo(p.x, p.y);
                });
                window.addEventListener('mouseup', () => drawing = false);
                canvas.addEventListener('mousemove', (e) => {
                    if(!drawing) return;
                    const p = getPos(e);
                    ctx.lineTo(p.x, p.y);
                    ctx.stroke();
                });
                root.querySelectorAll('.btn-color').forEach(btn => {
                    btn.addEventListener('click', () => { ctx.strokeStyle = btn.dataset.color; });
                });
                root.querySelector('.btn-clear').addEventListener('click', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
                
                w.getState = () => ({}); // No state to save
            }
            
            if (w.type === 'sound') {
                const bar = root.querySelector('.mic-bar');
                const slider = root.querySelector('.inp-sens');
                const startBtn = root.querySelector('.btn-mic-start');
                const overlay = root.querySelector('.mic-overlay');
                let isRunning = false;

                 if(state) slider.value = state.sensitivity;

                startBtn.addEventListener('click', async () => {
                    if(isRunning) return;
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        isRunning = true;
                        overlay.style.display = 'none';
                        
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        if(audioCtx.state === 'suspended') await audioCtx.resume();

                        const analyser = audioCtx.createAnalyser();
                        const source = audioCtx.createMediaStreamSource(stream);
                        source.connect(analyser);
                        analyser.fftSize = 256;
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
                        
                        const update = () => {
                            if(!root.isConnected) return; 
                            analyser.getByteFrequencyData(dataArray);
                            const avg = dataArray.reduce((a,b) => a+b) / dataArray.length;
                            const sens = parseInt(slider.value);
                            const h = Math.min(100, (avg * (sens/2))); 
                            bar.style.height = h + '%';
                            requestAnimationFrame(update);
                        };
                        update();
                    } catch (e) {
                        console.error("Mic Access Denied", e);
                        handlePermissionError(root.querySelector('.widget-content'), 'Microphone');
                    }
                });
                
                 w.getState = () => ({ sensitivity: slider.value });
            }

            if (w.type === 'poll') {
                const labels = root.querySelectorAll('.opt-label');
                const inputs = [root.querySelector('.inp-opt-a'), root.querySelector('.inp-opt-b')];
                
                if (state) {
                    polls[w.id] = state.votes || [0,0];
                    inputs[0].value = state.labelA;
                    inputs[1].value = state.labelB;
                } else {
                     polls[w.id] = [0,0];
                }
                labels[0].textContent = inputs[0].value;
                labels[1].textContent = inputs[1].value;
                updatePollVisuals(root.querySelector('.widget-content'), polls[w.id]);


                inputs.forEach((inp, i) => {
                    inp.addEventListener('input', () => { labels[i].textContent = inp.value.substring(0, 15); });
                });
                
                root.querySelectorAll('.btn-vote').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = parseInt(btn.dataset.idx);
                        polls[w.id][idx]++;
                        updatePollVisuals(root.querySelector('.widget-content'), polls[w.id]);
                    });
                });

                root.querySelector('.btn-reset').addEventListener('click', () => {
                    polls[w.id] = [0, 0];
                    updatePollVisuals(root.querySelector('.widget-content'), polls[w.id]);
                });

                 w.getState = () => ({
                    votes: polls[w.id],
                    labelA: inputs[0].value,
                    labelB: inputs[1].value
                });
            }

            if (w.type === 'webcam') {
                // State not saved for webcam as it's just a live feed.
                const startBtn = root.querySelector('.btn-cam-start');
                startBtn.addEventListener('click', () => {
                    const video = startBtn.previousElementSibling;
                    navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                        startBtn.style.display = 'none';
                    })
                    .catch(e => {
                        console.error("Camera Access Denied", e);
                        handlePermissionError(startBtn.parentElement, 'Camera');
                    });
                });
                w.getState = () => ({}); // No state
            }
            
            if (w.type === 'timetable') {
                const tbody = root.querySelector('.timetable-body');
                const textarea = root.querySelector('.inp-data');
                const btn = root.querySelector('.btn-apply');
                const emptyMsg = root.querySelector('.empty-msg');

                const renderTable = (data) => {
                     const lines = data.split('\n').filter(x => x.trim());
                     tbody.innerHTML = '';
                     if(lines.length > 0) {
                        emptyMsg.style.display = 'none';
                        lines.forEach(line => {
                            const parts = line.split('|');
                            const time = parts[0] ? parts[0].trim() : '';
                            const act = parts[1] ? parts[1].trim() : '';
                            
                            const tr = document.createElement('tr');
                            tr.className = 'border-b last:border-0';
                            tr.innerHTML = `<td class="p-2 font-bold text-indigo-600 whitespace-nowrap border-r bg-indigo-50/50">${time}</td><td class="p-2 text-slate-700">${act}</td>`;
                            tbody.appendChild(tr);
                        });
                    } else {
                         emptyMsg.style.display = 'block';
                    }
                }

                if(state) {
                    textarea.value = state.data;
                    renderTable(state.data);
                }

                btn.addEventListener('click', () => {
                    renderTable(textarea.value);
                    toggleSettings(w.id);
                });

                w.getState = () => ({ data: textarea.value });
            }
        }
        
        // --- Save & Load ---
        function handleSaveClick() {
            let name = currentDashboardName;
            if (!name) {
                name = prompt("Enter a name for this dashboard:", "My Dashboard");
                if (!name) return;
            } else {
                // Optional: Confirm overwrite or ask if they want to save as new?
                // For simplicity, let's just save if it exists, but maybe a long press or different UI for "Save As" is better.
                // But the prompt implies "Save As" if name is null.
                // Let's just prompt always if we want to allow renaming, but for now sticking to "Save" means save current.
                // Actually, users might want to rename.
                // Let's do: if we have a name, save it.
                // But how to rename? Maybe in the list.
                // Let's keep it simple: If it has a name, save it. If they want to save as new, they can just create new.
                // But wait, if they want to "Save As", I should probably always prompt?
                // No, standard behavior is Save updates current file.
                // To support "Save As", I would need another button.
                // Let's just use prompt if name is null.
            }

            saveDashboard(name);
        }

        function saveDashboard(name) {
            currentDashboardName = name;
            const state = {
                bg: document.getElementById('app-body').className,
                widgets: widgets.map(w => {
                    const rect = w.el.getBoundingClientRect();
                    return {
                        id: w.id,
                        type: w.type,
                        x: w.el.offsetLeft,
                        y: w.el.offsetTop,
                        w: w.el.offsetWidth,
                        h: w.el.offsetHeight,
                        z: w.el.style.zIndex,
                        minimized: w.el.classList.contains('minimized'),
                        settings: document.getElementById('flipper-' + w.id).classList.contains('flip-active'),
                        data: w.getState ? w.getState() : {}
                    };
                }),
                polls: polls // Save poll data separately
            };

            const jsonState = JSON.stringify(state);
            google.script.run
                .withSuccessHandler(response => {
                    showSaveIndicator(response);
                    // Refresh list so the new one appears/updates
                    loadDashboardList();
                })
                .withFailureHandler(alert)
                .saveDashboard(name, jsonState);
        }

        function loadInitialData(){
             google.script.run
                .withSuccessHandler(data => {
                    if(!data) return;
                    try {
                        dashboards = JSON.parse(data);
                        // Load the first one or Default
                        const keys = Object.keys(dashboards);
                        if (keys.length > 0) {
                            const toLoad = dashboards["Default"] || dashboards[keys[0]];
                            // If we loaded "Default", set name to Default. If random first, set name.
                            currentDashboardName = dashboards["Default"] ? "Default" : keys[0];
                            loadDashboardState(toLoad);
                        }
                    } catch(e) {
                        console.error("Error loading initial data:", e);
                    }
                })
                .getDashboards();
        }

        function loadDashboardList() {
             google.script.run
                .withSuccessHandler(data => {
                    if(!data) return;
                    try {
                        dashboards = JSON.parse(data);
                        renderDashboardList();
                    } catch(e) {
                        console.error("Error parsing dashboards list:", e);
                    }
                })
                .getDashboards();
        }

        function renderDashboardList() {
            const list = document.getElementById('dashboards-list');
            list.innerHTML = '';
            const keys = Object.keys(dashboards);

            if (keys.length === 0) {
                list.innerHTML = '<div class="text-sm text-slate-500 italic">No saved dashboards.</div>';
                return;
            }

            keys.forEach(name => {
                const item = document.createElement('div');
                item.className = `dashboard-item ${name === currentDashboardName ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="truncate font-medium text-sm">${name}</span>
                    <button class="text-slate-400 hover:text-red-500 btn-delete p-1" title="Delete"><i class="fa-solid fa-trash"></i></button>
                `;

                item.addEventListener('click', (e) => {
                    if(e.target.closest('.btn-delete')) return; // Don't trigger load if delete clicked
                    currentDashboardName = name;
                    loadDashboardState(dashboards[name]);
                    renderDashboardList(); // re-render to update active state
                    // document.getElementById('dashboards-menu').classList.add('hidden'); // Optional: close menu on select
                });

                item.querySelector('.btn-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(confirm(`Delete dashboard "${name}"?`)) {
                        google.script.run
                            .withSuccessHandler(res => {
                                if(res.success) {
                                    delete dashboards[name];
                                    if(currentDashboardName === name) currentDashboardName = null;
                                    renderDashboardList();
                                } else {
                                    alert(res.message);
                                }
                            })
                            .deleteDashboard(name);
                    }
                });

                list.appendChild(item);
            });
        }

        function loadDashboardState(state) {
            if(!state) return;
            // Clear existing
            widgets.forEach(w => w.el.remove());
            widgets = [];

            // Load background
            if(state.bg) {
                 setBg(state.bg.replace('h-screen w-screen overflow-hidden transition-colors duration-500 ', ''));
            } else {
                 setBg("bg-slate-900");
            }

            // Load widgets
            if(state.widgets) {
                state.widgets.forEach(s => spawnWidget(s.type, s));
            }

            // Load poll data
            if(state.polls) {
                polls = state.polls;
                // Need to re-render polls after loading
                    widgets.forEach(w => {
                    if(w.type === 'poll') {
                        updatePollVisuals(w.el.querySelector('.widget-content'), polls[w.id] || [0,0]);
                    }
                    });
            } else {
                polls = {};
            }
        }

        function showSaveIndicator(response) {
            if(response && response.success) {
                const indicator = document.getElementById('save-indicator');
                indicator.style.opacity = '1';
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 2000);
            } else {
                alert(response.message);
            }
        }

        // --- Global Helpers ---
        function handlePermissionError(container, featureName) {
            const isEmbedded = window.self !== window.top;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'perm-error';
            
            if(isEmbedded) {
                msgDiv.innerHTML = `
                    <div class="text-red-500 text-4xl mb-2"><i class="fa-solid fa-ban"></i></div>
                    <div class="font-bold text-slate-800">Blocked by Host Site</div>
                    <p class="text-xs text-slate-500 mb-3 px-4">Google Sites blocks ${featureName} access inside embeds.</p>
                    <button onclick="openInNewTab()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 text-sm font-bold">
                    <i class="fa-solid fa-up-right-from-square"></i> Open in New Tab
                    </button>`;
            } else {
                msgDiv.innerHTML = `
                    <div class="text-red-500 text-4xl mb-2"><i class="fa-solid fa-ban"></i></div>
                    <div class="font-bold text-slate-800">Access Denied</div>
                    <p class="text-xs text-slate-500 mb-2 px-4">Please allow ${featureName} access in your browser URL bar.</p>`;
            }
            container.appendChild(msgDiv);
        }

        function openInNewTab() {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }

        function updatePollVisuals(container, data) {
            const total = data[0] + data[1];
            const bars = container.querySelectorAll('.bar');
            const counts = container.querySelectorAll('.count');
            
            const p0 = total === 0 ? 0 : (data[0] / total) * 100;
            const p1 = total === 0 ? 0 : (data[1] / total) * 100;
            
            if(bars[0]) bars[0].style.height = (p0 === 0 && total > 0) ? '5px' : p0 + '%';
            if(bars[1]) bars[1].style.height = (p1 === 0 && total > 0) ? '5px' : p1 + '%';
            
            if(counts[0]) counts[0].textContent = data[0];
            if(counts[1]) counts[1].textContent = data[1];
        }

        function toggleSettings(id) {
            document.getElementById('flipper-' + id).classList.toggle('flip-active');
        }

        function toggleMinimize(id) {
            document.getElementById('widget-' + id).classList.toggle('minimized');
        }

        function closeWidget(id) {
            const el = document.getElementById('widget-' + id);
            if(el) el.remove();
            widgets = widgets.filter(w => w.id !== id);
        }

        function startDrag(e, id) {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
            const el = document.getElementById('widget-' + id);
            dragItem = el;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;
            initialX = el.offsetLeft;
            initialY = el.offsetTop;
            el.style.zIndex = getMaxZ() + 1;
        }

        function startResize(e, id) {
            e.stopPropagation();
            const el = document.getElementById('widget-' + id);
            resizeItem = el;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;
            initialW = el.offsetWidth;
            initialH = el.offsetHeight;
            el.style.zIndex = getMaxZ() + 1;
        }

        function handleMove(e) {
            if (dragItem) {
                const dx = e.clientX - initialMouseX;
                const dy = e.clientY - initialMouseY;
                let newX = initialX + dx;
                let newY = initialY + dy;

                if (e.shiftKey) {
                    newX = Math.round(newX / GRID) * GRID;
                    newY = Math.round(newY / GRID) * GRID;
                }

                dragItem.style.left = newX + 'px';
                dragItem.style.top = newY + 'px';
            }
            if (resizeItem) {
                const dx = e.clientX - initialMouseX;
                const dy = e.clientY - initialMouseY;
                resizeItem.style.width = Math.max(150, initialW + dx) + 'px';
                resizeItem.style.height = Math.max(100, initialH + dy) + 'px';
            }
        }

        function handleEnd() {
            dragItem = null;
            resizeItem = null;
        }

        function getMaxZ() {
            let max = 10;
            widgets.forEach(w => {
                const z = parseInt(w.el.style.zIndex || 0);
                if (z > max) max = z;
            });
            return max;
        }

        function playAlarm() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'triangle';
            osc.frequency.value = 440;
            
            const now = ctx.currentTime;
            gain.gain.setValueAtTime(1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            
            osc.start(now);
            osc.stop(now + 0.5);

            setTimeout(() => {
                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.type = 'triangle';
                osc2.frequency.value = 440;
                gain2.gain.setValueAtTime(1, ctx.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc2.start(ctx.currentTime);
                osc2.stop(ctx.currentTime + 0.5);
            }, 600);
        }

        function setBg(val) {
            const body = document.getElementById('app-body');
            const classList = body.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('from-') && !c.startsWith('via-') && !c.startsWith('to-'));
            body.className = [...classList, ...val.split(' ')].join(' ');

            if(val === 'bg-grid') {
                 body.classList.add('bg-slate-50');
                 body.style.backgroundImage = 'radial-gradient(#94a3b8 1px, transparent 1px)';
                 body.style.backgroundSize = '20px 20px';
            } else {
                body.style.backgroundImage = '';
            }
            document.getElementById('bg-menu').classList.add('hidden');
        }

        function startRecording(type) {
            console.log(`Start recording: ${type}`);
            let msg = "";
            if (type === 'voice') msg = "Voice Only recording started (Simulated)";
            else if (type === 'screen') msg = "Screen Only recording started (Simulated)";
            else if (type === 'both') msg = "Voice & Screen recording started (Simulated)";

            if (typeof showToast === 'function') {
                showToast(msg, 'info');
            } else {
                alert(msg);
            }
            // In a real implementation, we would use navigator.mediaDevices.getUserMedia()
            // and MediaRecorder here.
        }

        function showToast(message, type = 'info') {
            // Check if container exists, if not create it
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');

            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            const colorClass = colors[type] || colors.info;

            toast.className = `${colorClass} text-white px-4 py-3 rounded shadow-lg flex items-center gap-2 transform transition-all duration-300 translate-x-full opacity-0 pointer-events-auto`;
            toast.innerHTML = `
                <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-info'}"></i>
                <span class="font-medium text-sm">${message}</span>
            `;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
    </script>
</body>
</html>